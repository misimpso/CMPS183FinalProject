{{left_sidebar_enabled,right_sidebar_enabled=False,('message' in globals())}}
{{extend 'layout.html'}}

<div id="target">

</div>


<script id="template" type="text/ractive">
<div id="new_msg">
  <form action="#" class="form-horizontal" enctype="multipart/form-data" method="post">
  <div class="form-group" id="no_table_message__row">
  <label class="control-label col-sm-3" for="no_table_message" id="no_table_message__label">Message</label>
  <div class="col-sm-9">
  <textarea value="{% active_draft %}" class="text form-control" cols="40" id="no_table_message" name="message" rows="10">
  </textarea>
  <span class="help-block"></span></div></div>
  <div class="form-group" id="submit_record__row"><div class="col-sm-9 col-sm-offset-3">
  <input class="btn btn-primary" type="submit" value="Submit" /></div>
  </div></form>
</div>

<h2>Drafts:</h2>
<div class="message_list">
  {% #msg_dict:msg_id %}
    {% #if is_draft %}
      <div class="message">
        {% message_content %}
        <button class="btn btn-success" data-msgid="{% msg_id %}">Edit</button>
      </div>
    {% /if %}
  {% /msg_dict %}
</div>

<h2>Messages:</h2>
<div class="message_list">
  {% #msg_dict:msg_id %}
    {% #if !is_draft %}
      <div class="message">
        {% message_content %}
      </div>
    {% /if %}
  {% /msg_dict %}
</div>

{% #if loading %}
  <div id="load_spinner">
    <i class="fa fa-spinner fa-spin fa-4x"></i>
  </div>
{% /if %}

</script>

<script>
$(function() {

  // Ractive object
  var MAIN = new Ractive({
    el: '#target',
    template: '#template',
    delimiters: ['{%', '%}'],
    tripleDelimiters: ['{%%', '%%}'],
    data: {
      msg_dict: {},
      draft_id: "{{=draft_id}}",
      active_draft: "",
      loading: true
    },
  });

  // Loads the initial list of messages.
  $.ajax("{{=URL('default', 'load_messages', user_signature=True)}}",
          {
            method: 'POST',
            success: function (data) {
              MAIN.set('msg_dict', data['msg_dict']);
              MAIN.set('loading', false);
            }
          }
  );


  function send_message(msg_content, is_draft) {
    var call_draft_id = MAIN.get('draft_id');
    $.ajax("{{=URL('default', 'add_msg', user_signature=True)}}",
            {
              data: {
                msg: msg_content,
                is_draft: is_draft,
                msg_id: call_draft_id
              },
              method: 'POST',
              success: function() {
                // Reflect in the list of drafts the update to this draft.
                var msg_dict = MAIN.get('msg_dict');
                if (call_draft_id in msg_dict) {
                  msg_dict[call_draft_id]['message_content'] = msg_content;
                } else {
                  msg_dict[call_draft_id] = {
                    message_content: msg_content,
                    is_draft: is_draft
                  }
                }
                MAIN.set('msg_dict', msg_dict);
              },
              error: function() {}
            }
    );
  }

  var msg = $("div#new_msg textarea").val();

  // Called every 10s
  function periodic_send() {
    var new_msg = MAIN.get('active_draft');
    if (new_msg !== msg) {
      msg = new_msg;
      send_message(new_msg, true);
    }
  }

  // This code is called when the submit button is pressed.
  $("div#new_msg input[type=submit]").on("click", function() {
    var msg_content = $("div#new_msg textarea").val();
    // Send content back to server.
    send_message(msg_content, false);
    return false;
  });

  setInterval(periodic_send, 10000);
});
</script>
